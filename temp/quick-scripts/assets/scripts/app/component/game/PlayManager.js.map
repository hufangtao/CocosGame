{"version":3,"sources":["PlayManager.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"..\\..\\..\\..\\..\\..\\..\\assets\\scripts\\app\\component\\game","sourcesContent":["import {\r\n  PlayReadyC2S,\r\n  PlaySaveAnimalC2S,\r\n  PlaySaveAnimalS2C,\r\n  PlayNewRoundS2C,\r\n  PlayContinueS2C,\r\n  PlayReadyS2C,\r\n  PlayNewPhaseS2C,\r\n  PlayPvpFinishC2S, PlayStartPveS2C, PlayGenBlockS2C, PlayActiveBuffS2C, PlayStolenAnimalS2C, PlayBoardStatusS2C\r\n} from \"../../common/net/proto/mods/ProtoSectionPlay\";\r\nimport { RoomPlayFinishS2C, RoomPlayConfirmC2S, RoomInvisibleC2S } from \"../../common/net/proto/mods/ProtoSectionRoom\";\r\nimport NetUtil from \"../../common/net/NetUtil\";\r\nimport { Play, Home } from \"../../module/Modules\";\r\nimport HomeManager from \"../page/home/HomeManager\";\r\nimport { OpenHomeFrom } from \"../../common/Defines\";\r\nimport * as Modules from \"../../module/Modules\";\r\nimport PlayUIPve from \"./pve/PlayUIPve\";\r\nimport GamePersist from \"../../common/persist/GamePersist\";\r\nimport PlayUI from \"./pvp/PlayUI\";\r\nimport LevelChoose from \"../levelChoose/LevelChoose\";\r\n\r\n\r\nexport default class PlayManager {\r\n  private static singleInstance: PlayManager;\r\n\r\n  public confirmEnterRoom: boolean = false;\r\n  public bGameOver: boolean = false;\r\n\r\n  public static get INSTANCE() {\r\n    if (!this.singleInstance) {\r\n      this.singleInstance = new PlayManager();\r\n    }\r\n    return this.singleInstance;\r\n  }\r\n\r\n  private isOpponentLeave;\r\n\r\n  public get IsOpponentLeave() {\r\n    return this.isOpponentLeave;\r\n  }\r\n\r\n  private playUI: PlayUI;\r\n  public set PlayUI(value: PlayUI) {\r\n    this.playUI = value;\r\n  }\r\n  public get PlayUI(): PlayUI {\r\n    return this.playUI;\r\n  }\r\n\r\n  private playUIPve: PlayUIPve;\r\n  public set PlayUIPve(value: PlayUIPve) {\r\n    this.playUIPve = value;\r\n  }\r\n  public get PlayUIPve(): PlayUIPve {\r\n    return this.playUIPve;\r\n  }\r\n\r\n  private pveEnterType: number;\r\n  public set PveEnterType(value: number) {\r\n    this.pveEnterType = value;\r\n  }\r\n  public get PveEnterType(): number {\r\n    return this.pveEnterType;\r\n  }\r\n\r\n  private levelChoose: LevelChoose;\r\n  public set LevelChooseUI(value: LevelChoose) {\r\n    this.levelChoose = value;\r\n  }\r\n  public get LevelChooseUI(): LevelChoose {\r\n    return this.levelChoose;\r\n  }\r\n\r\n  // 收集到动物请求\r\n  public getAnimalRequest(roundId: number, slotIndex: number) {\r\n    const msg = new PlaySaveAnimalC2S();\r\n    NetUtil.SendMsg(msg);\r\n  }\r\n\r\n  public onPvpFinish(maxMatchCount) {\r\n    const msg = new PlayPvpFinishC2S();\r\n    msg.matchOnce = maxMatchCount;\r\n    NetUtil.SendMsg(msg);\r\n  }\r\n\r\n  // 收集到动物返回\r\n  public getAnimalResponse(obj: PlaySaveAnimalS2C) {\r\n    if (!this.playUI) {\r\n      return;\r\n    }\r\n    const saveCount = obj.saveCount;\r\n    const animalSide = obj.animalSide;\r\n    this.playUI.getAnimal(saveCount, animalSide);\r\n  }\r\n\r\n  // 生成一个障碍物\r\n  public genBlockResponse(obj: PlayGenBlockS2C) {\r\n    // console.log(\"生成一个障碍物 on myside :\", obj.genSide, Play.DataPlay.MySide);\r\n    this.playUI.genBlockResponse(obj.genSide, obj.row);\r\n  }\r\n\r\n  public newRound(newRoundS2C: PlayNewRoundS2C) {\r\n    this.playUI.newRound();\r\n  }\r\n  public onReadyResponse(playReady: PlayReadyS2C) {\r\n    this.playUI.onReadyResponse();\r\n  }\r\n\r\n  public onBack() {\r\n    this.bGameOver = false;\r\n    this.playUI = null;\r\n    this.isOpponentLeave = null;\r\n    this.invisibleRequest();\r\n    GamePersist.INSTANCE.loadScene(\"home\");\r\n  }\r\n  // 使自己不可见\r\n  public invisibleRequest() {\r\n    const invisibleMsg = new RoomInvisibleC2S();\r\n    NetUtil.SendMsg(invisibleMsg);\r\n  }\r\n  public newPhase(newPhase: PlayNewPhaseS2C) {\r\n    Play.DataPlay.Phase = newPhase.phaseId;\r\n  }\r\n\r\n  public startPve(startPveS2C: PlayStartPveS2C) {\r\n    switch (PlayManager.INSTANCE.PveEnterType) {\r\n      case 0: //new game\r\n        if (window['Partner'].energyTest() || startPveS2C.started == 1) {\r\n          this.LevelChooseUI.enterPveGame();\r\n        } else {\r\n          this.PlayUIPve.showEnergyEmpty(1);\r\n        }\r\n        break;\r\n      case 1: //next Level\r\n        if (window['Partner'].energyTest() || startPveS2C.started == 1) {\r\n          this.PlayUIPve.loadGame();\r\n        } else {\r\n          this.PlayUIPve.showEnergyEmpty(1);\r\n        }\r\n        break;\r\n      case 2: //continue\r\n        // if (Partner.energyTest() || startPveS2C.started == 1) {\r\n        //   this.PlayUIPve.playAgain();\r\n        // } else {\r\n        //   this.PlayUIPve.showEnergyEmpty(1);\r\n        // }\r\n      case 3: //restart game\r\n        if (window['Partner'].energyTest() || startPveS2C.started == 1) {\r\n          this.PlayUIPve.playAgain();\r\n        } else {\r\n          this.PlayUIPve.showEnergyEmpty(1);\r\n        }\r\n        break;\r\n    }\r\n\r\n  }\r\n\r\n  // 准备好\r\n  public onContinueResponse(playContinue: PlayContinueS2C) {\r\n    // 如果对方已经离开\r\n    if (this.isOpponentLeave) {\r\n      return;\r\n    }\r\n    const continueList: number[] = playContinue.continueList;\r\n    const cnt = continueList.length;\r\n    if (cnt < 1) {\r\n      return;\r\n    }\r\n\r\n    // 大于1代表两人都同意\r\n    if (cnt > 1) {\r\n      // this.selfRequestContinueBtn.interactable = false;\r\n      // this.opponentRequestContinueBtn.interactable = false;\r\n      // this.returnBtn.interactable = false;\r\n      // this.setContinueBtnText(\"双方同意再来一战\");\r\n      this.makeConfirmRequest();\r\n      this.didOneMorePlayStart();\r\n      return;\r\n    }\r\n\r\n    // 等于1代表只有一方同意\r\n    const continuePlaymateId = continueList[0];\r\n    if (continuePlaymateId === Play.DataPlay.OpponentId) {\r\n      if (this.playUI) {\r\n        this.playUI.setContinueBtn(2);\r\n      }\r\n      // this.setContinueBtnText(\"对方请求再来一局\");\r\n      // this.switchButtonState(ButtonType.kkOpponentRequestContinue);\r\n    } else {\r\n      // this.continueBtn.interactable = false;\r\n      // this.setContinueBtnText(\"等待对方同意\");\r\n      // this.switchButtonState(ButtonType.kkWaitOpponent);\r\n      if (this.playUI) {\r\n        this.playUI.setContinueBtn(4);\r\n      }\r\n    }\r\n  }\r\n  // 进行比赛确认\r\n  private makeConfirmRequest() {\r\n    const confirmC2S = new RoomPlayConfirmC2S();\r\n    NetUtil.SendMsg(confirmC2S);\r\n  }\r\n  // 再来一局开始已经确认开始\r\n  public didOneMorePlayStart() {\r\n    this.playUI.didOneMorePlay();\r\n  }\r\n  // 再来一局开始\r\n  public onOneMorePlayStart(roomId: number) {\r\n    // 确认当前是PlayUI\r\n    if (!this.playUI) {\r\n      cc.warn(`room:${roomId} playui not exist when one more play`);\r\n      return;\r\n    }\r\n    // 确认是同一个房间\r\n    if (Play.DataPlay.CurRoomId !== roomId) {\r\n      return;\r\n    }\r\n\r\n    this.bGameOver = false;\r\n    this.playUI.onOneMorePlay();\r\n  }\r\n\r\n\r\n  public onOpponentLeave() {\r\n    this.isOpponentLeave = true;\r\n    this.playUI.setContinueBtn(3);\r\n  }\r\n\r\n  // 一局结束 加载结算页面\r\n  public onPlayFinish(playResult: RoomPlayFinishS2C) {\r\n    this.playUI.onPlayFinish(playResult);\r\n  }\r\n\r\n  // 确认进入房间\r\n  public readyRequest() {\r\n    const readyMsg = new PlayReadyC2S();\r\n    readyMsg.roomId = Home.DataRoom.currentRoom;\r\n\r\n    NetUtil.SendMsg(readyMsg);\r\n  }\r\n\r\n  // 一方使用了道具\r\n  onActiveBuff(data: PlayActiveBuffS2C) {\r\n    if (data.effected) {\r\n      this.playUI.onActiveBuff(data);\r\n    }\r\n  }\r\n\r\n  // 偷取宠物\r\n  onStolenAnimal(data: PlayStolenAnimalS2C) {\r\n    this.playUI.onStolenAnimal(data);\r\n  }\r\n\r\n  // 棋盘上的宠物\r\n  onBoardStatusResponse(data: PlayBoardStatusS2C) {\r\n    this.playUI.onBoardStatusResponse(data);\r\n  }\r\n\r\n}\r\n"]}